const float h_hp[101] = {
  -0.00145896, -0.00147648, -0.00152709, -0.00161065, -0.00172690, -0.00187543,
  -0.00205572, -0.00226711, -0.00250881, -0.00277991, -0.00307939, -0.00340610,
  -0.00375880, -0.00413611, -0.00453658, -0.00495865, -0.00540068, -0.00586094,
  -0.00633763, -0.00682887, -0.00733274, -0.00784726, -0.00837039, -0.00890008,
  -0.00943422, -0.00997071, -0.01050741, -0.01104221, -0.01157299, -0.01209763,
  -0.01261405, -0.01312020, -0.01361406, -0.01409367, -0.01455713, -0.01500257,
  -0.01542824, -0.01583243, -0.01621353, -0.01657002, -0.01690048, -0.01720358,
  -0.01747813, -0.01772301, -0.01793726, -0.01812002, -0.01827056, -0.01838827,
  -0.01847268, -0.01852347, 0.98145958, -0.01852347, -0.01847268, -0.01838827,
  -0.01827056, -0.01812002, -0.01793726, -0.01772301, -0.01747813, -0.01720358,
  -0.01690048, -0.01657002, -0.01621353, -0.01583243, -0.01542824, -0.01500257,
  -0.01455713, -0.01409367, -0.01361406, -0.01312020, -0.01261405, -0.01209763,
  -0.01157299, -0.01104221, -0.01050741, -0.00997071, -0.00943422, -0.00890008,
  -0.00837039, -0.00784726, -0.00733274, -0.00682887, -0.00633763, -0.00586094,
  -0.00540068, -0.00495865, -0.00453658, -0.00413611, -0.00375880, -0.00340610,
  -0.00307939, -0.00277991, -0.00250881, -0.00226711, -0.00205572, -0.00187543,
  -0.00172690, -0.00161065, -0.00152709, -0.00147648, -0.00145896
};

const float h_bs[101] = {
  -5.99426401e-04, -4.91911956e-04, -1.94916878e-04, 2.05428557e-04,
  5.78322276e-04, 7.78022762e-04, 6.91429598e-04, 2.92114949e-04,
  -3.22816997e-04, -9.39156548e-04, -1.28851428e-03, -1.15533177e-03,
  -4.88410439e-04, 5.36325977e-04, 1.54445469e-03, 2.09056577e-03,
  1.84549347e-03, 7.67241600e-04, -8.27230250e-04, -2.34032079e-03,
  -3.11166241e-03, -2.69872275e-03, -1.10290163e-03, 1.16804827e-03,
  3.25127820e-03, 4.25435096e-03, 3.63316078e-03, 1.46320308e-03,
  -1.52530028e-03, -4.18801040e-03, -5.40634582e-03, -4.55687517e-03,
  -1.81297115e-03, 1.86287220e-03, 5.05665950e-03, 6.45240453e-03,
  5.37779930e-03, 2.11817715e-03, -2.14535210e-03, -5.76843201e-03,
  -7.28666270e-03, -6.01438689e-03, -2.35138104e-03, 2.33924053e-03,
  6.24674362e-03, 7.82405358e-03, 6.41081815e-03, 2.51365156e-03,
  -2.37642503e-03, -6.36293863e-03, 9.92109087e-01, -6.36293863e-03,
  -2.37642503e-03, 2.51365156e-03, 6.41081815e-03, 7.82405358e-03,
  6.24674362e-03, 2.33924053e-03, -2.35138104e-03, -6.01438689e-03,
  -7.28666270e-03, -5.76843201e-03, -2.14535210e-03, 2.11817715e-03,
  5.37779930e-03, 6.45240453e-03, 5.05665950e-03, 1.86287220e-03,
  -1.81297115e-03, -4.55687517e-03, -5.40634582e-03, -4.18801040e-03,
  -1.52530028e-03, 1.46320308e-03, 3.63316078e-03, 4.25435096e-03,
  3.25127820e-03, 1.16804827e-03, -1.10290163e-03, -2.69872275e-03,
  -3.11166241e-03, -2.34032079e-03, -8.27230250e-04, 7.67241600e-04,
  1.84549347e-03, 2.09056577e-03, 1.54445469e-03, 5.36325977e-04,
  -4.88410439e-04, -1.15533177e-03, -1.28851428e-03, -9.39156548e-04,
  -3.22816997e-04, 2.92114949e-04, 6.91429598e-04, 7.78022762e-04,
  5.78322276e-04, 2.05428557e-04, -1.94916878e-04, -4.91911956e-04,
  -5.99426401e-04
};

const float h_lp[101] = {
  -1.37004905e-18, 2.23337387e-04, 4.26451567e-04, 5.77077242e-04,
  6.40728084e-04, 5.85479126e-04, 3.90612468e-04, 5.74192659e-05,
  -3.81178708e-04, -8.56314900e-04, -1.26781656e-03, -1.49959465e-03,
  -1.44468859e-03, -1.03561270e-03, -2.72938962e-04, 7.56218957e-04,
  1.87734778e-03, 2.84978205e-03, 3.40967016e-03, 3.32856019e-03,
  2.47629437e-03, 8.73606192e-04, -1.28041891e-03, -3.61748765e-03,
  -5.65060704e-03, -6.86178088e-03, -6.81335273e-03, -5.26178351e-03,
  -2.24868393e-03, 1.85494746e-03, 6.36869247e-03, 1.03929398e-02,
  1.29612551e-02, 1.32325481e-02, 1.06894242e-02, 5.30351212e-03,
  -2.36961834e-03, -1.11937410e-02, -1.95651245e-02, -2.56272266e-02,
  -2.75584409e-02, -2.38880265e-02, -1.37862494e-02, 2.72481584e-03,
  2.46829098e-02, 5.02436613e-02, 7.68846255e-02, 1.01729214e-01,
  1.21942488e-01, 1.35136678e-01, 1.39720780e-01, 1.35136678e-01,
  1.21942488e-01, 1.01729214e-01, 7.68846255e-02, 5.02436613e-02,
  2.46829098e-02, 2.72481584e-03, -1.37862494e-02, -2.38880265e-02,
  -2.75584409e-02, -2.56272266e-02, -1.95651245e-02, -1.11937410e-02,
  -2.36961834e-03, 5.30351212e-03, 1.06894242e-02, 1.32325481e-02,
  1.29612551e-02, 1.03929398e-02, 6.36869247e-03, 1.85494746e-03,
  -2.24868393e-03, -5.26178351e-03, -6.81335273e-03, -6.86178088e-03,
  -5.65060704e-03, -3.61748765e-03, -1.28041891e-03, 8.73606192e-04,
  2.47629437e-03, 3.32856019e-03, 3.40967016e-03, 2.84978205e-03,
  1.87734778e-03, 7.56218957e-04, -2.72938962e-04, -1.03561270e-03,
  -1.44468859e-03, -1.49959465e-03, -1.26781656e-03, -8.56314900e-04,
  -3.81178708e-04, 5.74192659e-05, 3.90612468e-04, 5.85479126e-04,
  6.40728084e-04, 5.77077242e-04, 4.26451567e-04, 2.23337387e-04,
  -1.37004905e-18
};

#define N 101

typedef struct {
  float filter_coef[N];
  float buffer[N];
  int index;
} FIRFilter;

FIRFilter hpFilter;
FIRFilter bsFilter;
FIRFilter lpFilter;

HardwareTimer *timer = new HardwareTimer(TIM4);

volatile float last_sample = 0.0f;
volatile float threshold = 0.0f;
volatile float current_max = 0.0f;
volatile float bpm = 0;

volatile unsigned long last_crossing = 0;
volatile unsigned long last_update;

volatile bool is_above = false;
volatile bool was_above = false;

void updateThreshold(float x) {
  if (x > current_max) {
    current_max = x;
  }
}

void getBPM(float x, float threshold) {
  is_above = (x > threshold);

  if (is_above && !was_above) {
    unsigned long now = millis();
    unsigned long dt = now - last_crossing;

    if (dt > 200 && dt < 2000) {
      bpm = 60000 / dt;
    }
    last_crossing = now;
  }
  was_above = is_above;
}

// Initialize filter values
void FIR_init(FIRFilter *f, const float *coeffs) {
  for (int i = 0; i < N; i++) {
    f->filter_coef[i] = coeffs[i];
    f->buffer[i] = 0.0f;
  }
  f->index = 0;
}

// Convolve
float FIR_filter(FIRFilter *f, float x) {
  float *filter_coef = f->filter_coef;
  float *buffer = f->buffer;
  int index = f->index;

  float y = 0.0f;

  buffer[index] = x;

  int k = index;

  for (int i = 0; i < N; i++) {
    y += filter_coef[i] * buffer[k];
    k--;
    if (k < 0) k = N - 1;
  }

  index++;
  if (index >= N) index = 0;

  f->index = index;

  return y;
}

// Filter pipeline
float processECG(float x) {
  float y1 = FIR_filter(&hpFilter, x);
  float y2 = FIR_filter(&bsFilter, y1);
  float y3 = FIR_filter(&lpFilter, y2);
  return y3;
}

// Sample from hartware timer
void sampleISR() {
  float raw = analogRead(A0) / 1024.0f;
  last_sample = processECG(raw);
}

void setup() {
  Serial.begin(115200);

  FIR_init(&hpFilter, h_hp);
  FIR_init(&bsFilter, h_bs);
  FIR_init(&lpFilter, h_lp);

  timer->setOverflow(2000, MICROSEC_FORMAT); // 500Hz
  timer->attachInterrupt(sampleISR);
  timer->resume();

}

void loop() {
  updateThreshold(last_sample);
  getBPM(last_sample, threshold);
  
  // Update threshold every 1sek
  if (millis() - last_update >= 1000) {
    threshold = current_max * 0.6f;
    current_max = 0;
    last_update = millis();
  }

  Serial.print(analogRead(A0) / 1024.0f);
  Serial.print(",");
  Serial.print(last_sample);
  Serial.print(",");
  Serial.println(bpm); 

}
